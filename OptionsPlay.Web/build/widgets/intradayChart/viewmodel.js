define(["knockout","dataContext","modules/context","highstock"],function(e,t,n){Highcharts.setOptions({global:{timezoneOffset:8,useUTC:!1},lang:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],weekdays:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],loading:"加载中...",noData:"没有数据",resetZoom:"重置放大",resetZoomTitle:"1:1",shortMonths:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]}});var r=function(){var n=this,r=new Date;n.startTimeOfMorning=(new Date(Highcharts.dateFormat("%Y-%m-%d",r)+" 09:30")).valueOf(),n.closeTimeOfMorning=(new Date(Highcharts.dateFormat("%Y-%m-%d",r)+" 11:30")).valueOf(),n.startTimeOfAfternoon=(new Date(Highcharts.dateFormat("%Y-%m-%d",r)+" 13:01")).valueOf(),n.closeTimeOfAfternoon=(new Date(Highcharts.dateFormat("%Y-%m-%d",r)+" 15:00")).valueOf(),n.priceData=[],n.volumeData=[],n.currentTime=null,n.oneAndHalfHour=54e5,n.isValidMarketTime=function(e){return n.isMarketTimeOfMorning(e)||n.isMarketTimeOfAfternoon(e)},n.isMarketTimeOfMorning=function(e){return e>=n.startTimeOfMorning&&e<=n.closeTimeOfMorning},n.isMarketTimeOfAfternoon=function(e){return e>=n.startTimeOfAfternoon&&e<=n.closeTimeOfAfternoon},n.adjustXAxisValue=function(e){return e-n.oneAndHalfHour},this.activate=function(e){n.stockCode=e.stockCode,n.loadData()},this.loadData=function(){(n.isValidMarketTime((new Date).valueOf())||n.priceData.length<=0)&&t.stockQuotePerMin.get(e.unwrap(n.stockCode)).done(function(e){var t,r,i;n.priceData=[],n.volumeData=[];for(i=0;i<e.length;i++)t=e[i],r=(new Date(t.tradeDate)).valueOf(),n.isValidMarketTime(r)&&(n.isMarketTimeOfAfternoon(r)&&(r=n.adjustXAxisValue(r)),n.priceData.push([r,t.lastPrice]),n.volumeData.push([r,t.currentVolume]));console.log("draw intradayChart"),n.closePriceData=[];var s;typeof t!="undefined"?s=t.previousClose:s=0,n.closePriceData.push([n.startTimeOfMorning,s]),n.closePriceData.push([n.adjustXAxisValue(n.closeTimeOfAfternoon),s]),n.chart&&n.chart.series[0].update({data:n.priceData}),n.chart&&n.chart.series[1].update({data:n.volumeData}),n.chart&&n.chart.series[2].update({data:n.closePriceData})})},this.attached=function(e){n.chart=new Highcharts.Chart({chart:{renderTo:e,events:{load:function(){n.loadData(),n.dataLoadInterval=setInterval(n.loadData,6e4)}}},title:{text:""},tooltip:{formatter:function(){var e="";if(typeof this.points!="undefined"&&this.points.length==1)e="昨日收盘价："+this.y;else{var t=this.x;t>n.closeTimeOfMorning&&(t+=n.oneAndHalfHour),e+="<b>"+Highcharts.dateFormat("%H:%M",t)+"</b>",this.points[0]&&(e+="<br/> 价格："+this.points[0].y),this.points[1]&&(e+="<br/> 成交量："+this.points[1].y)}return e},shared:!0},xAxis:[{type:"datetime",min:n.startTimeOfMorning,max:n.closeTimeOfAfternoon-n.oneAndHalfHour,labels:{formatter:function(){var e=this.value;return e>n.closeTimeOfMorning&&(e+=n.oneAndHalfHour),Highcharts.dateFormat("%H:%M",e)}}}],yAxis:[{labels:{align:"right",x:-3},title:{text:"价格"},height:"70%",lineWidth:1},{labels:{align:"right",x:-3},title:{text:"成交量"},top:"75%",height:"25%",offset:0,lineWidth:1}],plotOptions:{series:{marker:{enabled:!1,lineWidth:1,lineColor:null}},line:{lineWidth:1},column:{borderWidth:1,color:"#7CB5ED"}},legend:{enabled:!1},series:[{name:"价格",data:n.priceData},{type:"column",name:"成交量",data:n.volumeData,yAxis:1},{name:"preivousClosePrice",data:n.closePriceData,color:"#7CB5ED",lineWidth:1,dashStyle:"dash"}],credits:{enabled:!1}})},this.detach=function(){clearInterval(n.dataLoadInterval)}};return r});