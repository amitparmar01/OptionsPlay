define(["knockout","dataContext","modules/context"],function(e,t,n){function r(){function l(e,t,n){var r=clone(s[o++]);o==s.length&&(o=0);var l=STXMarket.nextPeriod(a,i.layout.interval,1,i),c=new Date(u.getTime()+((new Date).getTime()-f));c.getTime()>=l.getTime()?(r.Date=yyyymmddhhmm(l),a=l):r.Date=yyyymmddhhmm(a),n(r)}function h(){l(i.symbol,i.layout.interval,function(e){if(!c)return;i.appendMasterData([e]),setTimeout(h,250)})}function p(e,t,n){var r=null;t=="day"||t=="week"||t=="month"?r=sampleData:t==5?r=sample5min:t==30&&(r=sample30min),n(r)}var r=this,i=!1;this.securityCode=n.ulCode,this.securityName=e.observable(),this.logToggled=e.observable(!1),this.studiesDialog=function(e,t,n){if(!i||i.chart.dataSet.length==0)return;$$("studyDialog").querySelectorAll(".title")[0].innerHTML=n.target.innerHTML,STXStudies.studyDialog(i,e,$$("studyDialog")),STXDialogManager.displayDialog("studyDialog"),$("#studyMenu").click()},this.createStudy=function(){STXStudies.go($$("studyDialog"),i),STXDialogManager.dismissDialog()},this.setChartType=function(e){i.setChartType(e)},STXMenuManager.useOverlays(!1);var s=[{Date:null,Open:155.43,High:155.44,Low:155.39,Close:155.4,Volume:466380},{Date:null,Open:155.41,High:155.48,Low:155.4,Close:155.46,Volume:466480},{Date:null,Open:155.45,High:155.55,Low:155.43,Close:155.5,Volume:466580},{Date:null,Open:155.49,High:155.51,Low:155.41,Close:155.41,Volume:466680},{Date:null,Open:155.41,High:155.49,Low:155.38,Close:155.47,Volume:466780},{Date:null,Open:155.47,High:155.5,Low:155.44,Close:155.45,Volume:466880},{Date:null,Open:155.45,High:155.47,Low:155.43,Close:155.46,Volume:500},{Date:null,Open:155.47,High:155.5,Low:155.44,Close:155.48,Volume:1e3},{Date:null,Open:155.49,High:155.49,Low:155.46,Close:155.47,Volume:3e4},{Date:null,Open:155.47,High:155.53,Low:155.46,Close:155.51,Volume:1e5},{Date:null,Open:155.51,High:155.52,Low:155.45,Close:155.47,Volume:3e3},{Date:null,Open:155.46,High:155.47,Low:155.37,Close:155.41,Volume:5e4},{Date:null,Open:155.41,High:155.42,Low:155.38,Close:155.41,Volume:1e5},{Date:null,Open:155.41,High:155.46,Low:155.4,Close:155.45,Volume:4e5},{Date:null,Open:155.32,High:155.48,Low:155.3,Close:155.41,Volume:5e5}],o=0,u=strToDateTime("2013-03-20 13:40"),a=u,f=(new Date).getTime(),c=!1;this.changePeriodicity=function(e){i.setPeriodicityV2(1,e)},this.crossHairOnOff=function(e){STXDrawingToolbar.setVectorType(i,""),STXDrawingToolbar.crosshairs(i,e),$(".drawBtn").click()},this.setVectorType=function(e){e?STXDrawingToolbar.setVectorType(i,e):i.clearDrawings(),$(".drawBtn").click()},this.toggleLog=function(){i.layout.semiLog=!i.layout.semiLog,i.draw(),i.changeOccurred("layout"),i.doDisplayCrosshairs(),r.logToggled(!r.logToggled())},this.createVolumePanel=function(){if(i.panelExists("vchart"))return;i.createPanel("Volume","vchart",100),i.draw(),$("#studyMenu").click()},this.toggleVolumeUnderlay=function(){i.setVolumeUnderlay(!i.layout.volumeUnderlay),$("#studyMenu").click()},this.attached=function(e){function n(e){if(e&&e.length==0)return;for(var t=0;t<e.length;t++)e[t].Open=parseFloat(e[t].Open),e[t].Close=parseFloat(e[t].Close),e[t].High=parseFloat(e[t].High),e[t].Low=parseFloat(e[t].Low),e[t].Volume=parseFloat(e[t].Volume),e[t].Adj_Close=parseFloat(e[t].Adj_Close);e.length>1&&e[e.length-1].Date==e[e.length-2].Date&&e.pop()}function s(e){var t=e.query.count;if(t>0){c=!1;var r=e.query.results.quote;r.reverse(),n(r),i.newChart($$("symbol").value,r)}}function u(e){var t=new Date,n=t.getDate();n<10&&(n="0"+n);var r=t.getMonth()+1;r<10&&(r="0"+r);var i=t.getFullYear(),s=i+"-"+r+"-"+n,u=i-1+"-"+r+"-"+n,a="http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.historicaldata%20where%20symbol%3D'"+e+"'%20and%20startDate%3D'"+u+"'%20and%20endDate%3D'"+s+"'&format=json&diagnostics=true&env=http%3A%2F%2Fdatatables.org%2Falltables.env&callback=cbfunc"+"&seq="+o++,f=document.createElement("script");$$("loading").style.display="block",f.src=a,f.onload=function(){$$("loading").style.display="none"},f.onerror=function(){$$("loading").style.display="none"},document.body.appendChild(f)}function a(){function e(e,t,n,r){r&&($$$("#symbol").value="");var i=[{symbol:"S",description:"Sprint Corporation",exchange:"NYSE"},{symbol:"SPY",description:"SPDR S&amp;P 500 ETF",exchange:"NYSE"},{symbol:"^GSPC",description:"SPDR S&amp;P 500",exchange:""},{symbol:"CSCO",description:"Cisco Systems, Inc.",exchange:"NASDAQ"},{symbol:"SWKS",description:"Skyworks Solutions Inc.",exchange:"NASDAQ"},{symbol:"GLD",description:"SPDR Gold Shares",exchange:"NYSE"},{symbol:"WMT",description:"Wal-Mart Stores Inc.",exchange:"NYSE"},{symbol:"SLV",description:"iShares Silver Trust",exchange:"NYSE"},{symbol:"DDD",description:"3D Systems Corp.",exchange:"NYSE"},{symbol:"GS",description:"The Goldman Sachs Group, Inc.",exchange:"NYSE"},{symbol:"USDAUD",description:"US Dollar Australian Dollar",exchange:"FX"},{symbol:"USDBRL",description:"US Dollar Brazilian Real",exchange:"FX"}];e.displayResults(i)}function t(e,t,n){u(t)}STXThemeManager.builtInThemes={Light:"Content/custom/stx-demo-theme-1.css",Dark:"Content/custom/stx-demo-theme-2.css"},STXMenuManager.makeMenus(),STXMenuManager.registerChart(i),STXThemeManager.setThemes({enabledTheme:"Light"},i),STXDrawingToolbar.initialize(),STXDrawingToolbar.setVectorType(i,null),STXTimeZoneWidget.initialize(STXStorageManager.get("timezone"),STXStorageManager.callbacker("timezone"));var n={input:$$$("#symbol"),textCallback:e,selectCallback:t,filters:["ALL","STOCKS","FOREX","INDEXES"]}}function f(){if($$("huOpen")){var e=Math.floor((STXChart.crosshairX-this.chart.left)/this.layout.candleWidth),t=this.chart.xaxis[e];$$("huOpen").innerHTML="",$$("huClose").innerHTML="",$$("huHigh").innerHTML="",$$("huLow").innerHTML="",$$("huVolume").innerHTML="",t!=null&&t.data&&($$("huOpen").innerHTML=this.formatPrice(t.data.Open),$$("huClose").innerHTML=this.formatPrice(t.data.Close),$$("huHigh").innerHTML=this.formatPrice(t.data.High),$$("huLow").innerHTML=this.formatPrice(t.data.Low),$$("huVolume").innerHTML=condenseInt(t.data.Volume))}}function l(){STX.ipad&&STX.isIOS7&&(STX.appendClassName($$$("html"),"ipad ios7"),$$$("body").style.height=pageHeight()+"px");var e=$$("chartContainer"),t=$$$(".stx-chartArea"),n=$$$(".stx-panel-side"),r=0;n&&n.offsetLeft&&(r=t.clientWidth-n.offsetLeft),e.style.width=t.clientWidth-r+"px";var s=0;$$$(".stx-footer")&&(s=$$$(".stx-footer").clientHeight),e.style.height=pageHeight()-getPos(e).y-s+"px",t.style.height=pageHeight()-getPos(t).y-s+"px",i&&i.chart.canvas!=null&&i.resizeChart()}function d(){var e=$$$(".stx-wrapper");if(window.fullScreenMode){var t=i.chart.maxTicks-i.chart.scroll;e.style.position=null,e.style.left=null,e.style.top=null,e.style.width=null;var n=$$("chartContainer"),r=$$$(".stx-chartArea");n.style.height=null,n.style.width=null,r.style.height=null,i.resizeChart(),i.chart.scroll=i.chart.maxTicks-t,i.draw()}else e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.width="100%",l(),i.resizeChart(),i.draw();window.fullScreenMode=!window.fullScreenMode}function v(){i&&i.chart.canvas!=null&&(window.fullScreenMode?l():i.resizeChart())}function m(){i.layout.crosshair=!0,i.changeOccurred("layout"),i.doDisplayCrosshairs(),i.draw()}function g(){var e="SPY1";p(e,"day",function(t){i.newChart(e,t),i.setPeriodicityV2(1,"day"),h()})}function y(e,n){t.historicalQuotes.get(e,{period:n}).done(function(e){var t=e(),n=[];for(var s=0;s<t.length;s++){var o={};o.Adj_Close=t[s].closePrice,s<t.length-1?t[s+1].lastClosePrice:t[s].closePrice,o.Close=t[s].closePrice,o.Date=t[s].tradeDate.substring(0,10),o.High=t[s].highPrice,o.Low=t[s].lowPrice,o.Open=t[s]["openPrice"]==0?t[s].closePrice:t[s].openPrice,o.Volume=t[s].Volume||t[s].matchQuantity,n.push(o)}i.newChart(r.securityName(),n),setTimeout(function(){i.resizeChart(),i.draw()},1e3)})}function b(e){t.quotation.get(e).done(function(t){r.securityName(t.securityName),y(e,"5y")})}i=new STXChart($(e).find("#chartContainer")[0]);var o=0;STXChart.prototype.prepend("headsUpHR",f),window.onresize=v,a(),b(this.securityCode()),this.securityCode.subscribe(function(e){i.newChart("",[]),b(e)}),m()}}return r});